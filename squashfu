#!/bin/bash

DEBUG=true
debug () {
    [[ $DEBUG ]] && echo -e '\033[1;33m??\033[1;m ' $*
}

info () {
    echo -e '\033[1;34m::\033[1;m ' $*
}

die () {
    echo -e '\033[1;31m!!\033[1;m ' $*
    exit 1
}

# Declare base options, overwrite with user specs as necessary
# MAKE SURE TO CHANGE THIS BEFORE PUSHING PUBLIC
CONFIG=/home/haruko/dev/git/squashfu/etc/squashfu
source $CONFIG
[[ $? -gt 0 ]] && die "Error in config file. Please check your syntax"

# Informational output w/ happy colors
mount_aufs_by_num () {
    # Check for the union already being mounted
    grep "${BKUP_ROOT}/rw" /proc/mounts && umount "$BKUP_ROOT/rw"

    # build branch string
    branches="br="
    for i in `seq 7 -1 1`; do
        branches="${branches}${BKUP_ROOT}/bins/${i}=ro:"
    done
    branches="${branches}${BKUP_ROOT}/ro=ro"

    # build and execute mount command
    debug "Mounting union as entirely read only"
    mount -t aufs none $BKUP_ROOT/rw -o udba=reval,$branches

    debug "Remount branch $i as read-write"
    mount -o remount,mod:bins/$1=rw "${BKUP_ROOT}/rw"
}

create_new_seed () {
    # For our very first seed, we're writing directly to disk, so
    # Delete the data after the squashed seed has been created
    #[[ "$1" == "--initial" ]] && run_rsync

    # Create a new squashfs based on the contents of the union
    debug "Making new squash seed $(basename $SEED)"
    mksquashfs "${BKUP_ROOT}/rw" "$SEED" -b 65536

    # Delete the rsync source since its now squashed
    #[[ "$1" == "--initial" ]] && rm -rf "${BKUP_ROOT}/rw/*"
}

move_old_tree () {
    storage="${BKUP_ROOT}/bkup-$(date +%Y-%m-%d)"
    mkdir "$storage"
    cd "$BKUP_ROOT" && mv {$SEED,bins/} "$storage"
}

mount_seed () {
    debug "Mounting seed"
    # Mount the squashed seed, failing if we can't
    mount -o loop,ro "${SEED}" "${BKUP_ROOT}/ro" || {
        die FATAL: Error mounting $SEED;
    }
}

mount_aufs_by_day() {
    # convert DoW to a number
    mount_aufs_by_num `date --date=$1 +%u`
}

run_rsync() {
    # Gather includes and excludes from config file
    # No error checking here -- user better not have
    # effed up the config
    INCLUDES=($(grep ^#+ $CONFIG | cut -d+ -f2-))
    EXCLUDES=($(grep ^#- $CONFIG | cut -d- -f2-))

    # rsync source to $BKUP_ROOT/rw
    debug "Rsync executing with:"
    debug "   Options: ${RSYNC_OPTS[@]}"
    debug "   Includes: ${INCLUDES[@]}"
    debug "   Excludes: ${EXCLUDES[@]}"
    rsync ${RSYNC_OPTS[@]} ${INCLUDES[@]} ${EXCLUDES[@]} ${BKUP_ROOT}/rw || return 1
}

# Unmount union and squash
unmount_all () {
    #Union must be unmounted first, or bad things happen
    debug Unmounting union...
    read -p "Continue..."
    umount "${BKUP_ROOT}/rw"
    debug Unmounting squash...
    read -p "Continue..."
    umount "$SEED"
}

# Sanity checks
#  - Are we root?
[[ $UID -eq 0 ]] || die Must be root!

#  - is our BKUP_ROOT valid? (FAIL)
[[ -w "${BKUP_ROOT}" ]] || 
    die "Backup root is not accessible. Please check your setting in /etc/squashfu"

# Blindly unmount all just in case
unmount_all

read -p "Continue..."

# - do we have a proper (expected) directory structure in place?
# Use cd to BKUP_ROOT to avoid issues with brace expansion in a quoted path
cd "$BKUP_ROOT" && mkdir -p {rw,ro,bins/{1,2,3,4,5,6,7}}

# Prep work
#  - does seed exist? (if not, our backup is creating the seed)
[[ -f "$SEED" ]] || {
    debug "No seed found -- creating a new one...";
    create_new_seed;
}

read -p "Continue..."

#  mount seed if it exists and is not already mounted
grep "${BKUP_ROOT}/ro" /proc/mounts || mount_seed

read -p "Continue..."

# Prepare union mount with proper bins
mount_aufs_by_num $(( $(date +%u) + $MODIFIER ))

read -p "Continue..."

# Ready for backup!
run_rsync

# 5) Cleanup 
#   - Is this resquash day? If so, we need a new squash
#   - If new squash creation fails, we're in trouble. (by default, keep previous week)
[[ $(date +%u) -eq $RESQUASH_DAY ]] && {
    create_new_seed
    # Set aside last week's tree if user opted to, else delete it all
    if [[ $KEEP_LAST_WEEK -eq 1 ]]; then
        move_old_tree
    else
        find "${BKUP_ROOT}/bins/" -type f -delete
        rm $SEED
    fi
}

read -p "Continue..."
unmount_all

# Do another sanity check -- check sizes of bins versus squash.
bin_size=$(du -s ${BKUP_ROOT}/bins | awk '{print $1}')
sfs_size=$(du -s $SEED awk '{print $1}')
if [[ bin_size -gt sfs_size ]]; then
    info "Your incrementals are larger than your seed! You might consider resquashing your backup with $0 --resquash"
fi

# 6) Optional behavior
#   --seed-initial      Create new seed
#   --rollback $1 $2    Rollback to the day specified by $1, mounting at $2
#   --resquash          Create a new seed
#
